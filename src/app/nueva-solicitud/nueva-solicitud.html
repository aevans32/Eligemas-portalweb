<div class="page-container">
  <app-header></app-header>

  <div class="title-container">
    <div class="title">
      <span>Nueva Solicitud</span>
    </div>
  </div>

  <div class="subtitle-container">
    <span>Completa los datos en 2 pasos.</span>
  </div>

  <div class="content-wrapper">
    <div class="content-inner">

      <!-- Step indicator -->
      <div class="stepper">
        <div class="step" [class.active]="step === 1" [class.done]="step > 1">
          <div class="dot">1</div>
          <span>Crédito</span>
        </div>

        <div class="line" [class.filled]="step === 2"></div>

        <div class="step" [class.active]="step === 2">
          <div class="dot">2</div>
          <span>Perfil</span>
        </div>
      </div>

      @if (loading) {
        <p>Cargando...</p>
      } @else {

        @if (errorMsg) {
          <p class="error">{{ errorMsg }}</p>
        }

        <form [formGroup]="form" (ngSubmit)="enviar()">

          <!-- ==================== STEP 1: Crédito ==================== -->
          @if (step === 1) {
            <section class="card">
              <h2>Datos del Crédito</h2>

              <mat-form-field 
                appearance="outline"
                [matTooltip]="tooltips.entidad_financiera_id"
                [matTooltipPosition]="tooltipPos"
                [matTooltipShowDelay]="tooltipDelay"
              >
                <mat-label>Entidad Financiera</mat-label>
                <mat-select formControlName="entidad_financiera_id">
                  <mat-option [value]="null">-- Selecciona --</mat-option>
                  @for (x of entidades; track x.id) {
                    <mat-option [value]="x.id">
                      {{ x.nombre }} @if (x.codigo) { ({{ x.codigo }}) }
                    </mat-option>
                  }
                </mat-select>

                @if (
                  form.controls.entidad_financiera_id.touched &&
                  form.controls.entidad_financiera_id.hasError('required')
                ) {
                  <mat-error>Selecciona una entidad financiera.</mat-error>
                }
              </mat-form-field>


              <mat-form-field 
                appearance="outline"
                [matTooltip]="tooltips.moneda_id"
                [matTooltipPosition]="tooltipPos"
                [matTooltipShowDelay]="tooltipDelay"
                >
                <mat-label>Moneda de Crédito</mat-label>
                <mat-select formControlName="moneda_id">
                  <mat-option [value]="null">-- Selecciona --</mat-option>
                  @for (x of monedas; track x.id) {
                    <mat-option [value]="x.id">
                      {{ x.codigo }} @if (x.nombre) { - {{ x.nombre }} }
                    </mat-option>
                  }
                </mat-select>

                @if (
                  form.controls.moneda_id.touched &&
                  form.controls.moneda_id.hasError('required')
                ) {
                  <mat-error>Selecciona una moneda.</mat-error>
                }
              </mat-form-field>

              

              <mat-form-field 
                appearance="outline"
                [matTooltip]="tooltips.monto_total_credito"
                [matTooltipPosition]="tooltipPos"
                [matTooltipShowDelay]="tooltipDelay"
                >
                <mat-label>Monto Total de Crédito (original)</mat-label>
                <input matInput type="number" step="0.01" formControlName="monto_total_credito" />
                @if (form.controls.monto_total_credito.touched && form.controls.monto_total_credito.hasError('required')) {
                  <mat-error>El monto total es obligatorio.</mat-error>
                }
              </mat-form-field>

              
              <mat-form-field 
                appearance="outline"
                [matTooltip]="tooltips.monto_actual_credito"
                [matTooltipPosition]="tooltipPos"
                [matTooltipShowDelay]="tooltipDelay"
                >
                <mat-label>Monto Actual de Crédito</mat-label>
                <input matInput type="number" step="0.01" formControlName="monto_actual_credito" />
                @if (form.controls.monto_actual_credito.touched && form.controls.monto_actual_credito.hasError('required')) {
                  <mat-error>El monto actual es obligatorio.</mat-error>
                }
              </mat-form-field>


              <mat-form-field 
                appearance="outline"
                [matTooltip]="tooltips.monto_cuota_mensual"
                [matTooltipPosition]="tooltipPos"
                [matTooltipShowDelay]="tooltipDelay"
              >
                <mat-label>Monto de la Cuota Mensual</mat-label>
                <input
                  matInput
                  type="number"
                  step="0.01"
                  min="0.01"
                  formControlName="monto_cuota_mensual"
                />

                @if (form.controls.monto_cuota_mensual.touched && form.controls.monto_cuota_mensual.hasError('required')) {
                  <mat-error>El monto de la cuota mensual es obligatorio.</mat-error>
                }

                @if (form.controls.monto_cuota_mensual.touched && form.controls.monto_cuota_mensual.hasError('min')) {
                  <mat-error>Debe ser mayor o igual a 0.01.</mat-error>
                }
              </mat-form-field>





              <mat-form-field 
                appearance="outline"
                [matTooltip]="tooltips.plazo_total_meses"
                [matTooltipPosition]="tooltipPos"
                [matTooltipShowDelay]="tooltipDelay"
                >
                <mat-label>Plazo Total de Crédito (meses)</mat-label>
                <input 
                  matInput 
                  type="number" 
                  min="1"
                  step="1"
                  formControlName="plazo_total_meses" />

                @if (form.controls.plazo_total_meses.touched && form.controls.plazo_total_meses.hasError('required')) {
                  <mat-error>Campo requerido.</mat-error>
                }

                @if (form.controls.plazo_total_meses.touched && form.controls.plazo_total_meses.hasError('min')) {
                  <mat-error>Debe ser mayor a 0.</mat-error>
                }
              </mat-form-field>

              <mat-form-field 
                appearance="outline"
                [matTooltip]="tooltips.numero_cuotas_pagadas"
                [matTooltipPosition]="tooltipPos"
                [matTooltipShowDelay]="tooltipDelay"
                >
                <mat-label>Número de Cuotas Pagadas a la Fecha</mat-label>
                <input 
                  matInput 
                  type="number" 
                  min="1"
                  step="1"
                  formControlName="numero_cuotas_pagadas" />

                @if (form.controls.numero_cuotas_pagadas.touched && form.controls.numero_cuotas_pagadas.hasError('required')) {
                  <mat-error>Campo requerido.</mat-error>
                }

                @if (form.controls.numero_cuotas_pagadas.touched && form.controls.numero_cuotas_pagadas.hasError('min')) {
                  <mat-error>Debe ser mayor a 0.</mat-error>
                }
              </mat-form-field>

              <mat-form-field 
                appearance="outline"
                [matTooltip]="tooltips.tea"
                [matTooltipPosition]="tooltipPos"
                [matTooltipShowDelay]="tooltipDelay"
                >
                <mat-label>TEA (%)</mat-label>
                <input matInput type="number" step="0.01" formControlName="tea" />

                @if (form.controls.tea.touched && form.controls.tea.hasError('required')) {
                  <mat-error>Campo requerido.</mat-error>
                }
                @if (form.controls.tea.touched && form.controls.tea.hasError('min')) {
                  <mat-error>No puede ser negativo.</mat-error>
                }
              </mat-form-field>

              <mat-form-field 
                appearance="outline"
                [matTooltip]="tooltips.tcea"
                [matTooltipPosition]="tooltipPos"
                [matTooltipShowDelay]="tooltipDelay"
                >
                <mat-label>TCEA (%)</mat-label>
                <input matInput type="number" step="0.01" formControlName="tcea" />

                @if (form.controls.tea.touched && form.controls.tea.hasError('required')) {
                  <mat-error>Campo requerido.</mat-error>
                }
                @if (form.controls.tea.touched && form.controls.tea.hasError('min')) {
                  <mat-error>No puede ser negativo.</mat-error>
                }
              </mat-form-field>

              <mat-form-field 
                appearance="outline"
                [matTooltip]="tooltips.placa_vehiculo"
                [matTooltipPosition]="tooltipPos"
                [matTooltipShowDelay]="tooltipDelay"
                >
                <mat-label>Placa del Vehículo</mat-label>
                <input 
                  matInput 
                  type="text" 
                  maxlength="6" 
                  formControlName="placa_vehiculo"
                  style="text-transform: uppercase" />
                @if (form.controls.placa_vehiculo.touched && form.controls.placa_vehiculo.hasError('maxlength')) {
                  <mat-error>Máximo 6 caracteres.</mat-error>
                }
              </mat-form-field>

              <div class="actions">
                <button mat-stroked-button type="button" (click)="goDashboard()">Volver</button>
                <button mat-flat-button type="button" (click)="goStep(2)">Siguiente</button>
              </div>
            </section>
          }

          <!-- ==================== STEP 2: Perfil ==================== -->
          @if (step === 2) {
            <section class="card">
              <h2>Datos del Perfil Crediticio</h2>


              <div
                [matTooltip]="tooltips.es_dependiente"
                [matTooltipPosition]="tooltipPos"
                [matTooltipShowDelay]="tooltipDelay"
              >
                <mat-radio-group formControlName="es_dependiente" class="radio-group">
                  <mat-radio-button [value]="true">Dependiente</mat-radio-button>
                  <mat-radio-button [value]="false">Independiente</mat-radio-button>
                </mat-radio-group>
              </div>

              

              @if (form.controls.es_dependiente.touched && form.controls.es_dependiente.hasError('required')) {
                <mat-error>Selecciona una opción.</mat-error>
              }



              @if (form.controls.es_dependiente.value === true) {
                <mat-form-field 
                  appearance="outline"
                  [matTooltip]="tooltips.ruc_empleador"
                  [matTooltipPosition]="tooltipPos"
                  [matTooltipShowDelay]="tooltipDelay"
                  >
                  <mat-label>RUC de Empleador</mat-label>
                  <input 
                    matInput 
                    type="text" 
                    inputmode="numeric" 
                    pattern="[0-9]*"
                    maxlength="11"
                    (keypress)="onlyNumbers($event)"
                    formControlName="ruc_empleador" />

                    @if (form.controls.ruc_empleador.touched && form.controls.ruc_empleador.hasError('required')) {
                      <mat-error>El RUC del empleador es obligatorio.</mat-error>
                    }

                    @if (form.controls.ruc_empleador.touched && form.controls.ruc_empleador.hasError('pattern')) {
                      <mat-error>El RUC debe tener exactamente 11 dígitos numéricos.</mat-error>
                    }
                </mat-form-field>

                <mat-form-field 
                  appearance="outline"
                  [matTooltip]="tooltips.razon_social_empleador"
                  [matTooltipPosition]="tooltipPos"
                  [matTooltipShowDelay]="tooltipDelay"
                  >
                  <mat-label>Razón Social de Empleador</mat-label>
                  <input matInput type="text" formControlName="razon_social_empleador" />

                  @if (form.controls.razon_social_empleador.touched && form.controls.razon_social_empleador.hasError('required')) {
                    <mat-error>La razón social es obligatoria.</mat-error>
                  }

                  @if (form.controls.razon_social_empleador.touched && form.controls.razon_social_empleador.hasError('minlength')) {
                    <mat-error>Debe tener al menos 3 caracteres.</mat-error>
                  }

                  @if (form.controls.razon_social_empleador.touched && form.controls.razon_social_empleador.hasError('maxlength')) {
                    <mat-error>Máximo 120 caracteres.</mat-error>
                  }

                  @if (form.controls.razon_social_empleador.touched && form.controls.razon_social_empleador.hasError('pattern')) {
                    <mat-error>Solo letras, números, espacios y . &amp; - /</mat-error>
                  }
                </mat-form-field>
              }



              @if (form.controls.es_dependiente.value === false) {
                <mat-form-field 
                  appearance="outline"
                  [matTooltip]="tooltips.ruc_titular"
                  [matTooltipPosition]="tooltipPos"
                  [matTooltipShowDelay]="tooltipDelay"
                  >
                  <mat-label>RUC de Titular</mat-label>
                  <input 
                    matInput 
                    type="text"
                    inputmode="numeric" 
                    pattern="[0-9]*" 
                    maxlength="11" 
                    (keypress)="onlyNumbers($event)"
                    formControlName="ruc_titular" />

                    @if (form.controls.ruc_titular.touched && form.controls.ruc_titular.hasError('required')) {
                      <mat-error>El RUC del titular es obligatorio.</mat-error>
                    }

                    @if (form.controls.ruc_titular.touched && form.controls.ruc_titular.hasError('pattern')) {
                      <mat-error>El RUC debe tener exactamente 11 dígitos numéricos.</mat-error>
                    }
                </mat-form-field>

                <mat-form-field 
                  appearance="outline"
                  [matTooltip]="tooltips.ocupacion"
                  [matTooltipPosition]="tooltipPos"
                  [matTooltipShowDelay]="tooltipDelay"
                  >
                  <mat-label>Ocupación</mat-label>
                  <input matInput type="text" maxlength="50" formControlName="ocupacion" />

                  @if (form.controls.ocupacion.touched && form.controls.ocupacion.hasError('required')) {
                    <mat-error>La ocupación es obligatoria.</mat-error>
                  }

                  @if (form.controls.ocupacion.touched && form.controls.ocupacion.hasError('minlength')) {
                    <mat-error>Debe tener al menos 2 caracteres.</mat-error>
                  }

                  @if (form.controls.ocupacion.touched && form.controls.ocupacion.hasError('maxlength')) {
                    <mat-error>Máximo 50 caracteres.</mat-error>
                  }

                  @if (form.controls.ocupacion.touched && form.controls.ocupacion.hasError('pattern')) {
                    <mat-error>Solo letras, números, espacios y . &amp; - /</mat-error>
                  }
                </mat-form-field>
              }


              <mat-form-field 
                appearance="outline"
                [matTooltip]="tooltips.moneda_ingreso_id"
                [matTooltipPosition]="tooltipPos"
                [matTooltipShowDelay]="tooltipDelay"
                >
                <mat-label>Moneda de Ingreso</mat-label>
                <mat-select formControlName="moneda_ingreso_id">
                  <mat-option [value]="null">-- Selecciona --</mat-option>
                  @for (x of monedas; track x.id) {
                    <mat-option [value]="x.id">
                      {{ x.codigo }} @if (x.nombre) { - {{ x.nombre }} }
                    </mat-option>
                  }
                </mat-select>
                @if (form.controls.moneda_ingreso_id.touched && form.controls.moneda_ingreso_id.hasError('required')) {
                  <mat-error>Campo requerido.</mat-error>
                }
              </mat-form-field>

              <mat-form-field 
                appearance="outline"
                [matTooltip]="tooltips.ingreso_bruto"
                [matTooltipPosition]="tooltipPos"
                [matTooltipShowDelay]="tooltipDelay"
                >
                <mat-label>Ingreso Bruto</mat-label>
                <input matInput type="number" step="0.01" formControlName="ingreso_bruto" />
                @if (form.controls.ingreso_bruto.touched && form.controls.ingreso_bruto.hasError('required')) {
                  <mat-error>Campo requerido.</mat-error>
                }
                @if (form.controls.ingreso_bruto.touched && form.controls.ingreso_bruto.hasError('min')) {
                  <mat-error>No puede ser negativo.</mat-error>
                }
              </mat-form-field>


              <div class="actions">

                <!--Boton Anterior-->
                <button mat-stroked-button type="button" (click)="goStep(1)">Anterior</button>

                <!--BOTON ENVIAR-->
                <button 
                  mat-flat-button 
                  type="submit" 
                  [disabled]="submitting || form.invalid || step !== 2"
                >
                  {{ submitting ? 'Enviando...' : 'Enviar' }}
                </button>

              </div>
            </section>
          }

        </form>
      }
    </div>
  </div>

  <app-footer></app-footer>
</div>
