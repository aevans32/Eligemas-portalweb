<div class="page-container">
  <app-header></app-header>

  <div class="title-container">
    <div class="title">
      <span>Nueva Solicitud</span>
    </div>
  </div>

  <div class="subtitle-container">
    <span>Completa los datos en 2 pasos.</span>
  </div>

  <div class="content-wrapper">
    <div class="content-inner">

      <!-- Step indicator -->
      <div class="stepper">
        <div class="step" [class.active]="step === 1" [class.done]="step > 1">
          <div class="dot">1</div>
          <span>Crédito</span>
        </div>

        <div class="line" [class.filled]="step === 2"></div>

        <div class="step" [class.active]="step === 2">
          <div class="dot">2</div>
          <span>Perfil</span>
        </div>
      </div>

      @if (loading) {
        <p>Cargando...</p>
      } @else {

        @if (errorMsg) {
          <p class="error">{{ errorMsg }}</p>
        }

        <form [formGroup]="form" (ngSubmit)="enviar()">

          <!-- ==================== STEP 1: Crédito ==================== -->
          @if (step === 1) {
            <section class="card">
              <h2>Datos del Crédito</h2>

              <mat-form-field appearance="outline">
                <mat-label>Entidad Financiera</mat-label>
                <mat-select formControlName="entidad_financiera_id">
                  <mat-option [value]="null">-- Selecciona --</mat-option>
                  @for (x of entidades; track x.id) {
                    <mat-option [value]="x.id">
                      {{ x.nombre }} @if (x.codigo) { ({{ x.codigo }}) }
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Moneda de Crédito</mat-label>
                <mat-select formControlName="moneda_id">
                  <mat-option [value]="null">-- Selecciona --</mat-option>
                  @for (x of monedas; track x.id) {
                    <mat-option [value]="x.id">
                      {{ x.codigo }} @if (x.nombre) { - {{ x.nombre }} }
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Monto Total de Crédito (original)</mat-label>
                <input matInput type="number" step="0.01" formControlName="monto_total_credito" />
              </mat-form-field>

              

              <mat-form-field appearance="outline">
                <mat-label>Monto Total de Crédito (original)</mat-label>
                <input matInput type="number" step="0.01" formControlName="monto_total_credito" />
                @if (form.controls.monto_total_credito.touched && form.controls.monto_total_credito.hasError('required')) {
                  <mat-error>Campo requerido.</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Plazo Total de Crédito (meses)</mat-label>
                <input matInput type="number" formControlName="plazo_total_meses" />
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Número de Cuotas Pagadas a la Fecha</mat-label>
                <input matInput type="number" formControlName="numero_cuotas_pagadas" />
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>TEA (%)</mat-label>
                <input matInput type="number" step="0.01" formControlName="tea" />
                @if (form.controls.tea.touched && form.controls.tea.hasError('required')) {
                  <mat-error>Campo requerido.</mat-error>
                }
                @if (form.controls.tea.touched && form.controls.tea.hasError('min')) {
                  <mat-error>No puede ser negativo.</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>TCEA (%)</mat-label>
                <input matInput type="number" step="0.01" formControlName="tcea" />
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Placa del Vehículo</mat-label>
                <input matInput type="text" maxlength="6" formControlName="placa_vehiculo" />
                @if (form.controls.placa_vehiculo.touched && form.controls.placa_vehiculo.hasError('maxlength')) {
                  <mat-error>Máximo 6 caracteres.</mat-error>
                }
              </mat-form-field>

              <div class="actions">
                <button mat-stroked-button type="button" (click)="goDashboard()">Anterior</button>
                <button mat-flat-button type="button" (click)="goStep(2)">Siguiente</button>
              </div>
            </section>
          }

          <!-- ==================== STEP 2: Perfil ==================== -->
          @if (step === 2) {
            <section class="card">
              <h2>Datos del Perfil Crediticio</h2>

              <mat-form-field appearance="outline">
                <mat-label>Condición Laboral</mat-label>
                <mat-select formControlName="condicion_laboral_id">
                  <mat-option [value]="null">-- Selecciona --</mat-option>
                  @for (x of condiciones; track x.id) {
                    <mat-option [value]="x.id">{{ x.nombre }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>RUC de Empleador</mat-label>
                <input matInput type="text" maxlength="11" formControlName="ruc_empleador" />
                @if (form.controls.ruc_empleador.touched && form.controls.ruc_empleador.hasError('maxlength')) {
                  <mat-error>Máximo 11 caracteres.</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Razón Social de Empleador</mat-label>
                <input matInput type="text" formControlName="razon_social_empleador" />
              </mat-form-field>


              <mat-form-field appearance="outline">
                <mat-label>RUC de Titular</mat-label>
                <input matInput type="text" maxlength="11" formControlName="ruc_titular" />
                @if (form.controls.ruc_titular.touched && form.controls.ruc_titular.hasError('maxlength')) {
                  <mat-error>Máximo 11 caracteres.</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Ocupación</mat-label>
                <input matInput type="text" maxlength="50" formControlName="ocupacion" />
                @if (form.controls.ocupacion.touched && form.controls.ocupacion.hasError('maxlength')) {
                  <mat-error>Máximo 50 caracteres.</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Moneda de Ingreso</mat-label>
                <mat-select formControlName="moneda_ingreso_id">
                  <mat-option [value]="null">-- Selecciona --</mat-option>
                  @for (x of monedas; track x.id) {
                    <mat-option [value]="x.id">
                      {{ x.codigo }} @if (x.nombre) { - {{ x.nombre }} }
                    </mat-option>
                  }
                </mat-select>
                @if (form.controls.moneda_ingreso_id.touched && form.controls.moneda_ingreso_id.hasError('required')) {
                  <mat-error>Campo requerido.</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Ingreso Bruto</mat-label>
                <input matInput type="number" step="0.01" formControlName="ingreso_bruto" />
                @if (form.controls.ingreso_bruto.touched && form.controls.ingreso_bruto.hasError('required')) {
                  <mat-error>Campo requerido.</mat-error>
                }
                @if (form.controls.ingreso_bruto.touched && form.controls.ingreso_bruto.hasError('min')) {
                  <mat-error>No puede ser negativo.</mat-error>
                }
              </mat-form-field>


              <div class="actions">
                <button mat-stroked-button type="button" (click)="goStep(1)">Anterior</button>
                <button mat-flat-button type="submit" [disabled]="submitting">
                  {{ submitting ? 'Enviando...' : 'Enviar' }}
                </button>
              </div>
            </section>
          }

        </form>
      }
    </div>
  </div>

  <app-footer></app-footer>
</div>
